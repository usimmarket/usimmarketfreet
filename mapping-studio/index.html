<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>freeT Mapping Studio</title>
  <style>
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:#0b0e12;color:#e7eef7}
    header{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:10px;align-items:center}
    header .badge{font-size:12px;padding:4px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;opacity:.9}
    .layout{display:grid;grid-template-columns:380px 1fr;min-height:calc(100vh - 48px)}
    .panel{border-right:1px solid rgba(255,255,255,.08);padding:12px;overflow:auto}
    .panel h3{margin:10px 0 8px;font-size:14px;opacity:.95}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .row label{font-size:12px;opacity:.9;min-width:104px}
    input[type="text"], input[type="number"], select{width:100%;background:#121822;border:1px solid rgba(255,255,255,.14);color:#e7eef7;border-radius:10px;padding:8px 10px;font-size:13px}
    input[type="file"]{font-size:12px}
    button{background:#1c2533;border:1px solid rgba(255,255,255,.14);color:#e7eef7;border-radius:12px;padding:8px 10px;font-size:13px;cursor:pointer}
    button:hover{border-color:rgba(255,255,255,.30)}
    .muted{font-size:12px;opacity:.75;line-height:1.35}
    .list{border:1px solid rgba(255,255,255,.10);border-radius:12px;overflow:hidden}
    .list .item{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;cursor:pointer;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .list .item:last-child{border-bottom:0}
    .list .item.active{background:rgba(0,186,255,.12)}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);opacity:.85}
    .canvasWrap{padding:12px;overflow:auto}
    .pagebar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    #pdfCanvas{background:#fff;border-radius:12px}
    .hint{font-size:12px;opacity:.8;margin-top:8px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;border:1px solid rgba(255,255,255,.18);border-bottom-color:rgba(255,255,255,.12);border-radius:8px;padding:2px 6px;font-size:12px;opacity:.9}
  </style>
</head>
<body>
<header>
  <div class="badge">freeT Mapping Studio</div>
  <div class="muted">PDF 위 클릭으로 좌표 저장 (PDF 좌표계: 좌하단 원점)</div>
</header>

<div class="layout">
  <aside class="panel">
    <h3>PDF</h3>
    <div class="row">
      <label>기본 PDF</label>
      <button id="btnLoadDefault">template.pdf</button>
    </div>
    <div class="row">
      <label>PDF 업로드</label>
      <input id="pdfFile" type="file" accept="application/pdf"/>
    </div>

    <h3>필드 목록</h3>
    <div class="row">
      <label>검색</label>
      <input id="search" type="text" placeholder="필드명 검색"/>
    </div>
    <div class="row">
      <label>추가</label>
      <input id="newField" type="text" placeholder="필드명 입력 후 Enter"/>
    </div>

    <div class="list" id="fieldList" style="margin-top:8px;max-height:300px;overflow:auto"></div>
    <div class="hint">선택된 필드: <span id="selKey" class="kbd">없음</span></div>

    <h3>선택 필드 설정</h3>
    <div class="row">
      <label>타입</label>
      <select id="fieldType">
        <option value="text">text</option>
        <option value="checkbox">checkbox</option>
      </select>
    </div>

    <div class="row">
      <label>source</label>
      <input id="fieldSource" type="text" placeholder='예) subscriber_name_print 또는 join_type'/>
    </div>

    <div class="row" id="onValueRow" style="display:none">
      <label>on_value</label>
      <input id="fieldOnValue" type="text" placeholder='예) new / mnp / foreigner'/>
    </div>

    <div class="row">
      <label>폰트 크기</label>
      <input id="fontSize" type="number" min="6" max="24" step="1" value="10"/>
    </div>
    <div class="row">
      <label>좌표 x</label>
      <input id="coordX" type="number" step="1" />
    </div>
    <div class="row">
      <label>좌표 y</label>
      <input id="coordY" type="number" step="1" />
    </div>
    <div class="row">
      <label>페이지</label>
      <input id="coordPage" type="number" min="1" step="1" value="1"/>
    </div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="btnNudgeUp">↑</button>
      <button id="btnNudgeDown">↓</button>
      <button id="btnNudgeLeft">←</button>
      <button id="btnNudgeRight">→</button>
      <span class="muted">키보드 ↑↓←→</span>
    </div>

    <h3>저장/내보내기</h3>
    <div class="row">
      <button id="btnExport">mapping.json 다운로드</button>
      <button id="btnImport">mapping.json 불러오기</button>
      <input id="mapFile" type="file" accept="application/json" style="display:none"/>
    </div>

    <div class="muted">
      ✅ 출력용 줄바꿈 필드:<br/>
      <span class="kbd">subscriber_name_print</span> (가입자명 칸에 매핑)<br/>
      <span class="kbd">autopay_holder_print</span> (예금주명 칸에 매핑)
      <br/><br/>
      ✅ checkbox 매핑 예시:<br/>
      - key: join_type_new / type: checkbox / source: join_type / on_value: new
    </div>
  </aside>

  <main class="canvasWrap">
    <div class="pagebar">
      <button id="prevPage">◀</button>
      <button id="nextPage">▶</button>
      <span>Page: <span id="pageNum" class="kbd">1</span> / <span id="pageCount" class="kbd">?</span></span>
      <span class="muted">클릭하면 현재 선택 필드에 좌표 저장</span>
    </div>
    <canvas id="pdfCanvas"></canvas>
    <div class="hint">클릭 좌표는 PDF 포인트 기준으로 저장돼요. (y = pageHeight - clickY)</div>
  </main>
</div>

<script>
  // Robust PDF.js loader (jsDelivr may be blocked on some networks)
  function __loadScript(src){
    return new Promise((resolve, reject)=>{
      const s=document.createElement('script');
      s.src=src;
      s.async=true;
      s.onload=()=>resolve(src);
      s.onerror=()=>reject(new Error('Failed to load '+src));
      document.head.appendChild(s);
    });
  }

  async function __loadPdfJs(){
    const candidates=[
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.js',
      'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js'
    ];
    let lastErr=null;
    for(const src of candidates){
      try{ await __loadScript(src); return src; }
      catch(e){ lastErr=e; }
    }
    throw lastErr || new Error('PDF.js load failed');
  }

  function __workerSrcFor(loadedFrom){
    // Try to pair worker with the same CDN when possible
    if(loadedFrom.includes('jsdelivr')) return 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
    if(loadedFrom.includes('unpkg')) return 'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
    if(loadedFrom.includes('cdnjs')) return 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js';
    return 'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
  }

  // --- App boot ---
  (async ()=>{
    let loadedFrom='';
    try{
      loadedFrom = await __loadPdfJs();
    }catch(err){
      console.error(err);
      alert(`PDF 렌더러(PDF.js) 로딩에 실패했습니다.
네트워크/확장프로그램(광고차단) 영향일 수 있어요.
다른 브라우저/시크릿 모드로 다시 시도해 주세요.`);
      return;
    }

    // Some environments block cross-origin workers; for 2-page PDFs we can safely disable the worker.
    // This prevents the "blank page" symptom when worker loading is blocked.
    const WORKER_SRC = __workerSrcFor(loadedFrom);

    // Boot the original app code
    (function(){

  const DEFAULT_PDF_URL = "../template.pdf";
  const DEFAULT_FIELDS_URL = "./fields.json";

  const state = {
    pdf: null,
    pageNum: 1,
    pageCount: 0,
    scale: 1,
    viewport: null,
    mapping: { meta: { pdf: "template.pdf", coord_system: "pdf_points_origin_bottom_left" }, fields: {} },
    fields: [],
    selected: null
  };

  pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_SRC;

  const el = (id)=>document.getElementById(id);
  const canvas = el("pdfCanvas");
  const ctx = canvas.getContext("2d");

  function renderFieldList(){
    const q = el("search").value.trim().toLowerCase();
    const list = el("fieldList");
    list.innerHTML = "";
    state.fields
      .filter(k => !q || k.toLowerCase().includes(q))
      .forEach(k=>{
        const item = document.createElement("div");
        item.className = "item" + (state.selected===k ? " active":"");
        const left = document.createElement("div");
        left.textContent = k;
        const pill = document.createElement("span");
        pill.className="pill";
        pill.textContent = state.mapping.fields[k]?.type || "—";
        item.appendChild(left);
        item.appendChild(pill);
        item.onclick = ()=>selectField(k);
        list.appendChild(item);
      });
  }

  function selectField(k){
    state.selected = k;
    el("selKey").textContent = k;

    const f = state.mapping.fields[k] || {type:"text", size:10, page: state.pageNum, x:0, y:0, source: k};
    el("fieldType").value = f.type || "text";
    el("fontSize").value = f.size ?? 10;
    el("coordX").value = f.x ?? "";
    el("coordY").value = f.y ?? "";
    el("coordPage").value = f.page ?? state.pageNum;

    // source can be string or array; show as string
    const src = Array.isArray(f.source) ? (f.source[0] || k) : (f.source || k);
    el("fieldSource").value = src;

    if((f.type || "text")==="checkbox"){
      el("onValueRow").style.display = "flex";
      el("fieldOnValue").value = f.on_value ?? "";
    }else{
      el("onValueRow").style.display = "none";
      el("fieldOnValue").value = "";
    }

    renderFieldList();
    drawOverlayMarker();
  }

  function ensureField(){
    if(!state.selected) return null;
    if(!state.mapping.fields[state.selected]){
      state.mapping.fields[state.selected] = {type: "text", size: 10, page: state.pageNum, x: 0, y: 0, source: state.selected};
    }
    return state.mapping.fields[state.selected];
  }

  function updateFieldFromUI(){
    const f = ensureField();
    if(!f) return;

    const t = el("fieldType").value;
    f.type = t;
    f.size = Number(el("fontSize").value || 10);
    f.x = Number(el("coordX").value || 0);
    f.y = Number(el("coordY").value || 0);
    f.page = Number(el("coordPage").value || state.pageNum);

    const src = el("fieldSource").value.trim() || state.selected;
    f.source = src;

    if(t === "checkbox"){
      el("onValueRow").style.display = "flex";
      const ov = el("fieldOnValue").value.trim();
      if(ov) f.on_value = ov;
      else delete f.on_value;
    }else{
      el("onValueRow").style.display = "none";
      delete f.on_value;
    }

    renderFieldList();
    drawOverlayMarker();
  }

  async function loadFields(){
    const res = await fetch(DEFAULT_FIELDS_URL);
    const j = await res.json();
    state.fields = j.fields || [];
    renderFieldList();
  }

  async function loadPdfFromUrl(url){
    const loadingTask = pdfjsLib.getDocument({ url, disableWorker: true });
    state.pdf = await loadingTask.promise;
    state.pageCount = state.pdf.numPages;
    el("pageCount").textContent = state.pageCount;
    state.pageNum = 1;
    await renderPage();
  }

  async function loadPdfFromFile(file){
    const buf = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: buf, disableWorker: true });
    state.pdf = await loadingTask.promise;
    state.pageCount = state.pdf.numPages;
    el("pageCount").textContent = state.pageCount;
    state.pageNum = 1;
    await renderPage();
  }

  async function renderPage(){
    if(!state.pdf) return;
    const page = await state.pdf.getPage(state.pageNum);
    const viewport = page.getViewport({scale: state.scale});
    state.viewport = viewport;
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);
    await page.render({canvasContext: ctx, viewport}).promise;
    el("pageNum").textContent = state.pageNum;
    drawOverlayMarker();
  }

  function drawOverlayMarker(){
    if(!state.selected || !state.viewport) return;
    const f = state.mapping.fields[state.selected];
    if(!f) return;
    if(Number(f.page) !== state.pageNum) return;

    // PDF (bottom-left) -> canvas (top-left)
    const x = (f.x ?? 0) * state.scale;
    const y = (state.viewport.height - (f.y ?? 0)) * state.scale;

    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI*2);
    ctx.fillStyle = "rgba(0,186,255,.35)";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,186,255,.85)";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  canvas.addEventListener("click", (ev)=>{
    if(!state.selected || !state.viewport) return;
    const rect = canvas.getBoundingClientRect();
    const cx = (ev.clientX - rect.left);
    const cy = (ev.clientY - rect.top);

    const pdfX = Math.round(cx / state.scale);
    const pdfY = Math.round((state.viewport.height - cy) / state.scale);

    el("coordX").value = pdfX;
    el("coordY").value = pdfY;
    el("coordPage").value = state.pageNum;
    updateFieldFromUI();
  });

  window.addEventListener("keydown", (e)=>{
    if(!state.selected) return;
    const step = 1;
    const f = ensureField(); if(!f) return;

    let changed = false;
    if(e.key==="ArrowUp"){ f.y = (f.y||0)+step; changed=true; }
    if(e.key==="ArrowDown"){ f.y = (f.y||0)-step; changed=true; }
    if(e.key==="ArrowLeft"){ f.x = (f.x||0)-step; changed=true; }
    if(e.key==="ArrowRight"){ f.x = (f.x||0)+step; changed=true; }
    if(changed){
      el("coordX").value = f.x;
      el("coordY").value = f.y;
      updateFieldFromUI();
      e.preventDefault();
    }
  });

  el("search").addEventListener("input", renderFieldList);
  el("newField").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      const k = el("newField").value.trim();
      if(k && !state.fields.includes(k)){
        state.fields.push(k);
        state.fields.sort();
      }
      el("newField").value="";
      renderFieldList();
      if(k) selectField(k);
    }
  });

  el("fieldType").addEventListener("change", ()=>{
    // toggle on_value row
    if(el("fieldType").value==="checkbox") el("onValueRow").style.display="flex";
    else el("onValueRow").style.display="none";
    updateFieldFromUI();
  });

  ["fieldSource","fieldOnValue","fontSize","coordX","coordY","coordPage"].forEach(id=>{
    el(id).addEventListener("input", updateFieldFromUI);
    el(id).addEventListener("change", updateFieldFromUI);
  });

  el("btnNudgeUp").onclick = ()=>{ const f=ensureField(); if(!f) return; f.y=(f.y||0)+1; selectField(state.selected); updateFieldFromUI(); };
  el("btnNudgeDown").onclick = ()=>{ const f=ensureField(); if(!f) return; f.y=(f.y||0)-1; selectField(state.selected); updateFieldFromUI(); };
  el("btnNudgeLeft").onclick = ()=>{ const f=ensureField(); if(!f) return; f.x=(f.x||0)-1; selectField(state.selected); updateFieldFromUI(); };
  el("btnNudgeRight").onclick = ()=>{ const f=ensureField(); if(!f) return; f.x=(f.x||0)+1; selectField(state.selected); updateFieldFromUI(); };

  el("btnLoadDefault").onclick = ()=>loadPdfFromUrl(DEFAULT_PDF_URL);

  el("pdfFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(f) await loadPdfFromFile(f);
  });

  el("prevPage").onclick = async ()=>{
    if(!state.pdf) return;
    state.pageNum = Math.max(1, state.pageNum-1);
    await renderPage();
  };
  el("nextPage").onclick = async ()=>{
    if(!state.pdf) return;
    state.pageNum = Math.min(state.pageCount, state.pageNum+1);
    await renderPage();
  };

  el("btnExport").onclick = ()=>{
    const out = JSON.stringify(state.mapping, null, 2);
    const blob = new Blob([out], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "mapping.json";
    a.click();
  };

  el("btnImport").onclick = ()=> el("mapFile").click();
  el("mapFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const txt = await f.text();
    try{
      state.mapping = JSON.parse(txt);
      state.mapping.fields = state.mapping.fields || {};
      renderFieldList();
      if(state.selected) selectField(state.selected);
    }catch(err){
      alert("JSON 파싱 실패: "+err);
    }
  });

  (async ()=>{
    await loadFields();
    await loadPdfFromUrl(DEFAULT_PDF_URL);
    if(state.fields.length) selectField(state.fields[0]);
  })();


    })();
  })();
</script>
</body>
</html>
